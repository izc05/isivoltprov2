<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IsivoltPro - Sistema de Inventario QR</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 50%, #7e8ba3 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            padding: 25px;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            color: white;
        }

        h1 {
            color: white;
            font-size: 26px;
            margin-bottom: 5px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .subtitle {
            color: rgba(255,255,255,0.9);
            font-size: 14px;
        }

        .tabs {
            display: flex;
            background: white;
            border-top: 1px solid #e0e0e0;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            background: white;
            border: none;
            cursor: pointer;
            font-size: 14px;
            color: #666;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #1e3c72;
            border-bottom-color: #1e3c72;
            font-weight: 600;
            background: #f8f9fa;
        }

        .content {
            background: white;
            padding: 20px;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 400px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .scan-section {
            text-align: center;
            padding: 20px 0;
        }

        #video {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            display: none;
            margin: 0 auto;
        }

        .btn {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(30, 60, 114, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 60, 114, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
            background: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #1e3c72;
            box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1);
        }

        .tool-card, .worker-card {
            background: white;
            padding: 18px;
            border-radius: 12px;
            margin-bottom: 12px;
            border-left: 5px solid #1e3c72;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .tool-card:hover, .worker-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .tool-card.out {
            border-left-color: #e74c3c;
            background: #fff5f5;
        }

        .tool-card.in {
            border-left-color: #27ae60;
            background: #f0fdf4;
        }

        .tool-name {
            font-weight: 600;
            color: #333;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .tool-info {
            color: #666;
            font-size: 14px;
            margin: 3px 0;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 5px;
        }

        .status-available {
            background: #d4edda;
            color: #155724;
        }

        .status-out {
            background: #f8d7da;
            color: #721c24;
        }

        .qr-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 10px 0;
            border: 2px dashed #1e3c72;
        }

        .qr-code {
            margin: 15px auto;
        }

        .history-item {
            background: white;
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #1e3c72;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: relative;
            padding-left: 50px;
        }

        .history-item::before {
            content: '';
            position: absolute;
            left: 16px;
            top: 16px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #1e3c72;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .history-date {
            font-size: 13px;
            color: #666;
            margin-bottom: 5px;
            font-weight: 500;
        }

        .history-action {
            font-weight: 600;
            color: #1e3c72;
            font-size: 15px;
            margin-bottom: 3px;
        }

        .history-out {
            border-left-color: #e74c3c;
        }

        .history-out::before {
            background: #e74c3c;
        }

        .history-in {
            border-left-color: #27ae60;
        }

        .history-in::before {
            background: #27ae60;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .scan-result {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
        }

        .scan-error {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            padding: 20px;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            max-width: 400px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-group .btn {
            flex: 1;
        }

        .camera-icon {
            width: 60px;
            height: 60px;
            margin: 20px auto;
            display: block;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 16px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(30, 60, 114, 0.3);
        }

        .stat-number {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 13px;
            opacity: 0.9;
        }

        .filter-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 10px;
        }

        .filter-label {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .date-badge {
            display: inline-block;
            background: #e8f4f8;
            color: #1e3c72;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }

        .time-badge {
            display: inline-block;
            background: #f0f0f0;
            color: #666;
            padding: 4px 10px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
        }

        .export-btn {
            background: #27ae60;
            margin-top: 0;
        }

        .export-btn:hover {
            background: #229954;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 12px;
            margin-top: 0;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .btn-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge-category {
            background: #e8f4f8;
            color: #1e3c72;
        }

        .low-stock-warning {
            background: #fff3cd;
            border-left: 4px solid #f39c12;
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 13px;
            color: #856404;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .dashboard-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        }

        .dashboard-card h3 {
            margin: 0 0 15px 0;
            color: #1e3c72;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .kpi-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(30, 60, 114, 0.3);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            pointer-events: none;
        }

        .kpi-value {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .kpi-label {
            font-size: 13px;
            opacity: 0.9;
            font-weight: 500;
        }

        .kpi-trend {
            font-size: 12px;
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .quick-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .quick-stat-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
        }

        .quick-stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #1e3c72;
            margin-bottom: 3px;
        }

        .quick-stat-label {
            font-size: 12px;
            color: #666;
        }

        .recent-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .recent-item {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
        }

        .recent-item:last-child {
            border-bottom: none;
        }

        .recent-time {
            color: #999;
            font-size: 11px;
        }

        .alert-item {
            background: #fff3cd;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 13px;
            color: #856404;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            border-left: 4px solid #f39c12;
        }

        .alert-item.critical {
            background: #f8d7da;
            color: #721c24;
            border-left-color: #e74c3c;
        }

        .alert-actions {
            display: flex;
            gap: 5px;
            margin-top: 8px;
        }

        .alert-btn {
            background: white;
            border: 1px solid currentColor;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            font-weight: 600;
        }

        .chart-container {
            margin-top: 15px;
        }

        .chart-bar {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .chart-label {
            width: 120px;
            font-size: 12px;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chart-bar-fill {
            height: 24px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 4px;
            display: flex;
            align-items: center;
            padding: 0 10px;
            color: white;
            font-size: 11px;
            font-weight: 600;
            min-width: 40px;
            transition: width 0.3s ease;
        }

        .chart-line {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 120px;
            padding: 10px 0;
            border-bottom: 2px solid #e0e0e0;
            gap: 8px;
        }

        .chart-line-bar {
            flex: 1;
            background: linear-gradient(180deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 4px 4px 0 0;
            position: relative;
            min-height: 10px;
            transition: all 0.3s ease;
        }

        .chart-line-bar:hover {
            opacity: 0.8;
        }

        .chart-line-label {
            text-align: center;
            font-size: 11px;
            color: #666;
            margin-top: 5px;
        }

        .search-box-dash {
            width: 100%;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 15px;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .search-box-dash:focus {
            outline: none;
            border-color: #1e3c72;
            box-shadow: 0 0 0 3px rgba(30, 60, 114, 0.1);
        }

        .quick-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 20px;
        }

        .quick-action-btn {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            padding: 20px 15px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(30, 60, 114, 0.3);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .quick-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 60, 114, 0.4);
        }

        .quick-action-icon {
            font-size: 28px;
        }

        .ranking-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            background: #f8f9fa;
        }

        .ranking-position {
            font-size: 24px;
            margin-right: 12px;
        }

        .ranking-info {
            flex: 1;
        }

        .ranking-name {
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }

        .ranking-stats {
            font-size: 12px;
            color: #666;
        }

        .category-bar {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
        }

        .category-name {
            width: 140px;
            font-size: 13px;
            color: #333;
            font-weight: 500;
        }

        .category-progress {
            flex: 1;
            height: 24px;
            background: #f0f0f0;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        .category-progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: white;
            font-size: 11px;
            font-weight: 600;
            transition: width 0.3s ease;
        }

        .empty-state-dash {
            text-align: center;
            padding: 30px;
            color: #999;
            font-size: 14px;
        }

        .tab-indicator {
            background: #e74c3c;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            font-weight: 600;
            margin-left: 5px;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 2000;
            animation: slideIn 0.3s ease;
            max-width: 350px;
        }

        .notification.success {
            border-left: 4px solid #27ae60;
        }

        .notification.error {
            border-left: 4px solid #e74c3c;
        }

        .notification-icon {
            width: 24px;
            height: 24px;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
            font-size: 14px;
            color: #333;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(400px);
                opacity: 0;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0;
            }
            
            body {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <div>
                    <h1>‚ö° IsivoltPro</h1>
                    <p class="subtitle">Control inteligente de inventario</p>
                </div>
                <button onclick="downloadApp()" title="Descargar app para m√≥vil"
                    style="background:rgba(255,255,255,0.2); border:2px solid rgba(255,255,255,0.5);
                           color:white; padding:8px 14px; border-radius:8px; font-size:12px;
                           font-weight:600; cursor:pointer; margin-top:4px; white-space:nowrap;">
                    üíæ Guardar App
                </button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">üìä Panel</button>
            <button class="tab" onclick="switchTab('scan')">üì∑ Escanear</button>
            <button class="tab" onclick="switchTab('tools')">üì¶ Materiales</button>
            <button class="tab" onclick="switchTab('workers')">üë∑ Personal</button>
            <button class="tab" onclick="switchTab('history')">üìã Historial</button>
        </div>

        <div class="content">
            <!-- TAB DASHBOARD -->
            <div id="dashboard-tab" class="tab-content active">
                <h2 style="margin-bottom: 15px;">Panel de Control</h2>
                
                <!-- B√∫squeda R√°pida -->
                <input type="text" class="search-box-dash" id="dashSearch" 
                       placeholder="üîç Buscar material, c√≥digo o persona..." 
                       oninput="dashboardSearch(this.value)">
                
                <!-- KPIs Principales -->
                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-value" id="kpi-total">0</div>
                        <div class="kpi-label">Total Materiales</div>
                        <div class="kpi-trend" id="kpi-total-trend"></div>
                    </div>
                    <div class="kpi-card" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%);">
                        <div class="kpi-value" id="kpi-available">0</div>
                        <div class="kpi-label">Disponibles</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="kpi-available-progress"></div>
                        </div>
                    </div>
                    <div class="kpi-card" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                        <div class="kpi-value" id="kpi-in-use">0</div>
                        <div class="kpi-label">En Uso Ahora</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="kpi-in-use-progress"></div>
                        </div>
                    </div>
                    <div class="kpi-card" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
                        <div class="kpi-value" id="kpi-workers">0</div>
                        <div class="kpi-label">Personal Activo</div>
                        <div class="kpi-trend" id="kpi-workers-trend"></div>
                    </div>
                </div>

                <!-- Alertas Cr√≠ticas y Actividad Semanal -->
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>‚ö†Ô∏è Atenci√≥n Requerida <span class="tab-indicator" id="alerts-count">0</span></h3>
                        <div id="alerts-container"></div>
                    </div>

                    <div class="dashboard-card">
                        <h3>üìà Actividad Semanal</h3>
                        <div class="chart-line" id="weekly-chart"></div>
                    </div>
                </div>

                <!-- Top Personal y Uso por Categor√≠a -->
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>üèÜ Top Personal</h3>
                        <div id="top-workers-container"></div>
                    </div>

                    <div class="dashboard-card">
                        <h3>üìä Uso por Categor√≠a</h3>
                        <div id="category-usage-container"></div>
                    </div>
                </div>

                <!-- Materiales M√°s Usados y Actividad Reciente -->
                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>üî• Materiales M√°s Usados</h3>
                        <div class="chart-container" id="most-used-chart"></div>
                    </div>

                    <div class="dashboard-card">
                        <h3>‚è±Ô∏è Actividad Reciente</h3>
                        <div class="recent-list" id="recent-activity"></div>
                    </div>
                </div>

                <!-- Personal con Materiales -->
                <div class="dashboard-card">
                    <h3>üë• Personal con Materiales Asignados</h3>
                    <div class="chart-container" id="workers-chart"></div>
                </div>

                <!-- Acciones R√°pidas -->
                <div class="quick-actions">
                    <button class="quick-action-btn" onclick="switchTab('scan')">
                        <div class="quick-action-icon">üì∑</div>
                        <div>Escanear QR</div>
                    </button>
                    <button class="quick-action-btn" onclick="showAddToolModal(); switchTab('tools')">
                        <div class="quick-action-icon">‚ûï</div>
                        <div>A√±adir Material</div>
                    </button>
                    <button class="quick-action-btn" onclick="exportHistory(); switchTab('history')">
                        <div class="quick-action-icon">üìä</div>
                        <div>Exportar Datos</div>
                    </button>
                </div>
            </div>

            <!-- TAB ESCANEAR -->
            <div id="scan-tab" class="tab-content">
                <div class="scan-section">
                    <svg class="camera-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path>
                    </svg>
                    <h2 style="margin-bottom: 10px;">Escanear C√≥digo QR</h2>
                    <p style="color: #666; margin-bottom: 20px;">Usa la c√°mara para registrar entrada/salida</p>
                    
                    <video id="video" autoplay playsinline></video>
                    <canvas id="canvas" style="display: none;"></canvas>
                    
                    <div id="scanResult"></div>
                    
                    <button id="startScanBtn" class="btn" onclick="startScanning()">
                        üì∑ Iniciar Escaneo
                    </button>
                    <button id="stopScanBtn" class="btn btn-secondary" onclick="stopScanning()" style="display: none;">
                        ‚èπÔ∏è Detener Escaneo
                    </button>
                    
                    <div style="margin: 20px 0; text-align: center; color: #999;">
                        <div style="display: flex; align-items: center; margin: 15px 0;">
                            <div style="flex: 1; height: 1px; background: #ddd;"></div>
                            <span style="padding: 0 10px; font-size: 13px;">o</span>
                            <div style="flex: 1; height: 1px; background: #ddd;"></div>
                        </div>
                    </div>
                    
                    <button class="btn" style="background: #6c757d;" onclick="showManualEntryModal()">
                        ‚å®Ô∏è Entrada Manual de C√≥digo
                    </button>
                </div>
            </div>

            <!-- TAB HERRAMIENTAS -->
            <div id="tools-tab" class="tab-content">
                <h2 style="margin-bottom: 15px;">Gesti√≥n de Materiales</h2>
                
                <input type="text" id="searchTools" placeholder="üîç Buscar materiales..." 
                       oninput="searchTools()" style="margin-bottom: 15px;">
                
                <button class="btn" onclick="showAddToolModal()">‚ûï A√±adir Material</button>
                
                <div id="toolsList" style="margin-top: 20px;"></div>
            </div>

            <!-- TAB TRABAJADORES -->
            <div id="workers-tab" class="tab-content">
                <h2 style="margin-bottom: 15px;">Gesti√≥n de Personal</h2>
                
                <input type="text" id="searchWorkers" placeholder="üîç Buscar personal..." 
                       oninput="searchWorkers()" style="margin-bottom: 15px;">
                
                <button class="btn" onclick="showAddWorkerModal()">‚ûï A√±adir Personal</button>
                
                <div id="workersList" style="margin-top: 20px;"></div>
            </div>

            <!-- TAB HISTORIAL -->
            <div id="history-tab" class="tab-content">
                <h2 style="margin-bottom: 15px;">Historial de Movimientos</h2>
                
                <!-- Estad√≠sticas -->
                <div class="stats-container" id="statsContainer"></div>
                
                <!-- Filtros -->
                <div class="filter-section">
                    <div class="filter-label">Filtrar por fecha</div>
                    <div class="filter-row">
                        <input type="date" id="filterDateFrom" onchange="applyFilters()">
                        <input type="date" id="filterDateTo" onchange="applyFilters()">
                    </div>
                    <div class="filter-row">
                        <select id="filterType" onchange="applyFilters()">
                            <option value="">Todos los movimientos</option>
                            <option value="out">Solo salidas</option>
                            <option value="in">Solo entradas</option>
                        </select>
                        <select id="filterWorker" onchange="applyFilters()">
                            <option value="">Todo el personal</option>
                        </select>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn export-btn" style="flex:1;" onclick="exportHistory()">üìä Exportar Excel (.xlsx)</button>
                        <button class="btn btn-secondary" style="flex:1; margin-top:10px;" onclick="exportCSVFallback()">üìÑ Exportar CSV</button>
                    </div>
                </div>
                
                <div id="historyList"></div>
            </div>
        </div>
    </div>

    <!-- MODAL A√ëADIR HERRAMIENTA -->
    <div id="addToolModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">A√±adir Material</div>
            <div class="form-group">
                <label>Nombre del material</label>
                <input type="text" id="toolName" placeholder="Ej: Taladro Bosch / Cable 2.5mm">
            </div>
            <div class="form-group">
                <label>C√≥digo/N√∫mero de serie</label>
                <input type="text" id="toolCode" placeholder="Ej: MAT-001">
            </div>
            <div class="form-group">
                <label>Categor√≠a</label>
                <select id="toolCategory">
                    <option value="">-- Seleccionar categor√≠a --</option>
                    <option value="Herramientas">Herramientas</option>
                    <option value="Material El√©ctrico">Material El√©ctrico</option>
                    <option value="Equipos">Equipos</option>
                    <option value="Consumibles">Consumibles</option>
                    <option value="EPIs">EPIs (Equipos de Protecci√≥n)</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
            <div class="form-group">
                <label>Ubicaci√≥n (opcional)</label>
                <input type="text" id="toolLocation" placeholder="Ej: Almac√©n A - Estante 3">
            </div>
            <div class="form-group">
                <label>Descripci√≥n (opcional)</label>
                <input type="text" id="toolDescription" placeholder="Detalles adicionales">
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="closeModal('addToolModal')">Cancelar</button>
                <button class="btn" onclick="addTool()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- MODAL A√ëADIR TRABAJADOR -->
    <div id="addWorkerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">A√±adir Personal</div>
            <div class="form-group">
                <label>Nombre completo</label>
                <input type="text" id="workerName" placeholder="Ej: Juan Garc√≠a">
            </div>
            <div class="form-group">
                <label>N√∫mero de empleado</label>
                <input type="text" id="workerCode" placeholder="Ej: EMP-001">
            </div>
            <div class="form-group">
                <label>Departamento/√Årea (opcional)</label>
                <select id="workerDepartment">
                    <option value="">-- Seleccionar --</option>
                    <option value="El√©ctrico">El√©ctrico</option>
                    <option value="Fontaner√≠a">Fontaner√≠a</option>
                    <option value="Carpinter√≠a">Carpinter√≠a</option>
                    <option value="Mantenimiento">Mantenimiento</option>
                    <option value="Producci√≥n">Producci√≥n</option>
                    <option value="Almac√©n">Almac√©n</option>
                    <option value="Otro">Otro</option>
                </select>
            </div>
            <div class="form-group">
                <label>Tel√©fono (opcional)</label>
                <input type="tel" id="workerPhone" placeholder="Ej: 612345678">
            </div>
            <div class="form-group">
                <label>Email (opcional)</label>
                <input type="email" id="workerEmail" placeholder="Ej: juan@empresa.com">
            </div>
            <div class="btn-group">
                <button class="btn btn-secondary" onclick="closeModal('addWorkerModal')">Cancelar</button>
                <button class="btn" onclick="addWorker()">Guardar</button>
            </div>
        </div>
    </div>

    <!-- MODAL REGISTRAR MOVIMIENTO -->
    <div id="movementModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="movementTitle">Registrar Movimiento</div>
            <div id="movementContent"></div>
        </div>
    </div>

    <!-- MODAL VER QR -->
    <div id="qrModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;">
                <span>üì± C√≥digo QR</span>
                <button onclick="closeModal('qrModal')" style="background:none;border:none;font-size:24px;cursor:pointer;color:#999;line-height:1;">‚úï</button>
            </div>
            <div id="qrContent"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <!-- SheetJS para exportar Excel real (.xlsx) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        // Fallback librer√≠a QR si falla CDN principal
        window.addEventListener('load', function() {
            if (typeof QRCode === 'undefined') {
                const s = document.createElement('script');
                s.src = 'https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js';
                document.head.appendChild(s);
            }
        });
    </script>

    <script>
        // ALMACENAMIENTO DE DATOS
        let tools = JSON.parse(localStorage.getItem('tools')) || [];
        let workers = JSON.parse(localStorage.getItem('workers')) || [];
        let history = JSON.parse(localStorage.getItem('history')) || [];

        // Datos de ejemplo si est√° vac√≠o
        if (tools.length === 0) {
            tools = [
                { id: '1', name: 'Taladro Bosch', code: 'MAT-001', category: 'Herramientas', location: 'Almac√©n A - Est. 1', description: 'Taladro percutor 750W', status: 'available', assignedTo: null },
                { id: '2', name: 'Mult√≠metro Fluke', code: 'MAT-002', category: 'Equipos', location: 'Taller Principal', description: 'Mult√≠metro digital', status: 'available', assignedTo: null },
                { id: '3', name: 'Cable 2.5mm (rollo 100m)', code: 'MAT-003', category: 'Material El√©ctrico', location: 'Almac√©n B - Est. 5', description: 'Cable unipolar', status: 'available', assignedTo: null }
            ];
            saveData();
        }

        if (workers.length === 0) {
            workers = [
                { id: '1', name: 'Juan Garc√≠a', code: 'EMP-001', department: 'El√©ctrico', phone: '612345678', email: 'juan@empresa.com' },
                { id: '2', name: 'Mar√≠a L√≥pez', code: 'EMP-002', department: 'Mantenimiento', phone: '698765432', email: 'maria@empresa.com' },
                { id: '3', name: 'Carlos Ruiz', code: 'EMP-003', department: 'Producci√≥n', phone: '655555555', email: 'carlos@empresa.com' }
            ];
            saveData();
        }

        function saveData() {
            localStorage.setItem('tools', JSON.stringify(tools));
            localStorage.setItem('workers', JSON.stringify(workers));
            localStorage.setItem('history', JSON.stringify(history));
        }

        // NAVEGACI√ìN DE PESTA√ëAS
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName + '-tab').classList.add('active');
            
            if (tabName === 'dashboard') renderDashboard();
            if (tabName === 'tools') renderTools();
            if (tabName === 'workers') renderWorkers();
            if (tabName === 'history') renderHistory();
        }

        // DASHBOARD MEJORADO
        function renderDashboard() {
            renderKPIs();
            renderAlerts();
            renderWeeklyActivity();
            renderTopWorkers();
            renderCategoryUsage();
            renderMostUsedMaterials();
            renderRecentActivity();
            renderWorkersWithMaterials();
        }

        function renderKPIs() {
            const totalMaterials = tools.length;
            const available = tools.filter(t => t.status === 'available').length;
            const inUse = tools.filter(t => t.status === 'out').length;
            const activeWorkers = new Set(tools.filter(t => t.assignedTo).map(t => t.assignedTo)).size;
            
            document.getElementById('kpi-total').textContent = totalMaterials;
            document.getElementById('kpi-available').textContent = available;
            document.getElementById('kpi-in-use').textContent = inUse;
            document.getElementById('kpi-workers').textContent = activeWorkers;
            
            // Porcentajes para las barras de progreso
            const availablePercent = totalMaterials > 0 ? (available / totalMaterials * 100) : 0;
            const inUsePercent = totalMaterials > 0 ? (inUse / totalMaterials * 100) : 0;
            
            document.getElementById('kpi-available-progress').style.width = availablePercent + '%';
            document.getElementById('kpi-in-use-progress').style.width = inUsePercent + '%';
            
            // Tendencias (comparaci√≥n con datos simulados)
            const totalTrend = totalMaterials > 0 ? '+' + Math.floor(Math.random() * 5) + '% vs anterior' : '';
            const workersTrend = activeWorkers + ' de ' + workers.length + ' activos';
            
            document.getElementById('kpi-total-trend').textContent = totalTrend;
            document.getElementById('kpi-workers-trend').textContent = workersTrend;
        }

        function renderAlerts() {
            const container = document.getElementById('alerts-container');
            const alerts = [];
            
            // Materiales asignados hace m√°s de 7 d√≠as (CR√çTICO)
            const weekAgo = new Date();
            weekAgo.setDate(weekAgo.getDate() - 7);
            
            const criticalMaterials = [];
            history.forEach(h => {
                if (h.type === 'out') {
                    const checkoutDate = new Date(h.date);
                    if (checkoutDate < weekAgo) {
                        const tool = tools.find(t => t.id === h.toolId);
                        if (tool && tool.status === 'out') {
                            const days = Math.floor((new Date() - checkoutDate) / (1000 * 60 * 60 * 24));
                            criticalMaterials.push({
                                tool: h.toolName,
                                worker: h.workerName,
                                days: days,
                                workerId: h.workerId,
                                critical: days > 15
                            });
                        }
                    }
                }
            });
            
            // Ordenar por d√≠as (m√°s cr√≠ticos primero)
            criticalMaterials.sort((a, b) => b.days - a.days);
            
            // Mostrar alertas
            if (criticalMaterials.length === 0) {
                // Verificar alto uso de inventario
                const materialsInUse = tools.filter(t => t.status === 'out').length;
                const totalMaterials = tools.length;
                const usagePercentage = totalMaterials > 0 ? (materialsInUse / totalMaterials * 100) : 0;
                
                if (usagePercentage > 80) {
                    container.innerHTML = `
                        <div class="alert-item">
                            <div style="flex: 1;">
                                <strong>üìä Alto uso de inventario</strong>
                                <div style="font-size: 12px; margin-top: 4px;">
                                    ${usagePercentage.toFixed(0)}% de materiales en uso (${materialsInUse}/${totalMaterials})
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    container.innerHTML = '<div class="empty-state-dash">‚úì Todo en orden</div>';
                }
            } else {
                container.innerHTML = criticalMaterials.slice(0, 5).map(alert => {
                    const worker = workers.find(w => w.id === alert.workerId);
                    const phone = worker && worker.phone ? worker.phone : '';
                    
                    return `
                        <div class="alert-item ${alert.critical ? 'critical' : ''}">
                            <div style="font-size: 20px;">${alert.critical ? 'üî¥' : '‚ö†Ô∏è'}</div>
                            <div style="flex: 1;">
                                <strong>${alert.tool}</strong>
                                <div style="font-size: 12px; margin-top: 4px;">
                                    Asignado a: ${alert.worker} | Hace ${alert.days} d√≠as
                                </div>
                                <div class="alert-actions">
                                    ${phone ? `<button class="alert-btn" onclick="window.location.href='tel:${phone}'">üìû Llamar</button>` : ''}
                                    <button class="alert-btn" onclick="showWorkerDetails('${alert.workerId}')">Ver Detalles</button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Actualizar contador de alertas
            document.getElementById('alerts-count').textContent = criticalMaterials.length;
            document.getElementById('alerts-count').style.display = criticalMaterials.length > 0 ? 'inline-block' : 'none';
        }

        function renderWeeklyActivity() {
            const container = document.getElementById('weekly-chart');
            const days = ['L', 'M', 'X', 'J', 'V', 'S', 'D'];
            const today = new Date();
            const weekData = [0, 0, 0, 0, 0, 0, 0];
            
            // Calcular movimientos por d√≠a de la semana
            history.forEach(h => {
                const date = new Date(h.date);
                const dayDiff = Math.floor((today - date) / (1000 * 60 * 60 * 24));
                if (dayDiff < 7) {
                    const dayIndex = 6 - dayDiff;
                    if (dayIndex >= 0 && dayIndex < 7) {
                        weekData[dayIndex]++;
                    }
                }
            });
            
            const maxValue = Math.max(...weekData, 1);
            
            container.innerHTML = weekData.map((value, index) => {
                const height = (value / maxValue * 100);
                return `
                    <div style="flex: 1; display: flex; flex-direction: column; align-items: center;">
                        <div class="chart-line-bar" style="height: ${height}%" title="${value} movimientos"></div>
                        <div class="chart-line-label">${days[index]}</div>
                    </div>
                `;
            }).join('');
        }

        function renderTopWorkers() {
            const container = document.getElementById('top-workers-container');
            
            // Contar movimientos por trabajador
            const workerActivity = {};
            history.forEach(h => {
                workerActivity[h.workerId] = (workerActivity[h.workerId] || 0) + 1;
            });
            
            // Ordenar por actividad
            const sorted = Object.entries(workerActivity)
                .map(([workerId, count]) => {
                    const worker = workers.find(w => w.id === workerId);
                    return worker ? { ...worker, movements: count } : null;
                })
                .filter(w => w !== null)
                .sort((a, b) => b.movements - a.movements)
                .slice(0, 5);
            
            if (sorted.length === 0) {
                container.innerHTML = '<div class="empty-state-dash">Sin actividad registrada</div>';
                return;
            }
            
            const medals = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£'];
            
            container.innerHTML = sorted.map((worker, index) => {
                const materialsAssigned = tools.filter(t => t.assignedTo === worker.id).length;
                return `
                    <div class="ranking-item">
                        <div class="ranking-position">${medals[index]}</div>
                        <div class="ranking-info">
                            <div class="ranking-name">${worker.name}</div>
                            <div class="ranking-stats">
                                ${worker.movements} movimientos | ${materialsAssigned} materiales actualmente
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderCategoryUsage() {
            const container = document.getElementById('category-usage-container');
            
            // Contar materiales por categor√≠a
            const categoryCount = {};
            tools.forEach(t => {
                const cat = t.category || 'Sin categor√≠a';
                categoryCount[cat] = (categoryCount[cat] || 0) + 1;
            });
            
            const sorted = Object.entries(categoryCount)
                .sort((a, b) => b[1] - a[1]);
            
            if (sorted.length === 0) {
                container.innerHTML = '<div class="empty-state-dash">Sin datos</div>';
                return;
            }
            
            const total = tools.length;
            
            container.innerHTML = sorted.map(([category, count]) => {
                const percentage = (count / total * 100).toFixed(0);
                return `
                    <div class="category-bar">
                        <div class="category-name">${category}</div>
                        <div class="category-progress">
                            <div class="category-progress-fill" style="width: ${percentage}%">
                                ${count} (${percentage}%)
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderMostUsedMaterials() {
            const container = document.getElementById('most-used-chart');
            
            // Contar uso de cada material
            const materialUsage = {};
            history.forEach(h => {
                if (h.type === 'out') {
                    materialUsage[h.toolName] = (materialUsage[h.toolName] || 0) + 1;
                }
            });
            
            // Ordenar y tomar los top 5
            const sorted = Object.entries(materialUsage)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            if (sorted.length === 0) {
                container.innerHTML = '<div class="empty-state-dash">Sin datos de uso</div>';
                return;
            }
            
            const maxValue = sorted[0][1];
            
            container.innerHTML = sorted.map(([name, count]) => {
                const width = (count / maxValue * 100);
                return `
                    <div class="chart-bar">
                        <div class="chart-label" title="${name}">${name}</div>
                        <div class="chart-bar-fill" style="width: ${width}%">
                            ${count} ${count === 1 ? 'uso' : 'usos'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderRecentActivity() {
            const container = document.getElementById('recent-activity');
            const recentHistory = history.slice(0, 10);
            
            if (recentHistory.length === 0) {
                container.innerHTML = '<div class="empty-state-dash">Sin actividad reciente</div>';
                return;
            }
            
            container.innerHTML = recentHistory.map(item => {
                const date = new Date(item.date);
                const timeAgo = getTimeAgo(date);
                const icon = item.type === 'out' ? 'üì§' : 'üì•';
                const action = item.type === 'out' ? 'Salida' : 'Entrada';
                const color = item.type === 'out' ? '#e74c3c' : '#27ae60';
                
                return `
                    <div class="recent-item">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 18px;">${icon}</span>
                            <div style="flex: 1;">
                                <div><strong>${item.toolName}</strong></div>
                                <div style="color: #666; font-size: 12px;">
                                    <span style="color: ${color}; font-weight: 600;">${action}</span> ‚Ä¢ ${item.workerName}
                                </div>
                                <div class="recent-time">${timeAgo}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderWorkersWithMaterials() {
            const container = document.getElementById('workers-chart');
            
            // Contar materiales por trabajador
            const workerMaterials = {};
            tools.forEach(t => {
                if (t.assignedTo) {
                    const worker = workers.find(w => w.id === t.assignedTo);
                    if (worker) {
                        if (!workerMaterials[worker.name]) {
                            workerMaterials[worker.name] = {
                                count: 0,
                                materials: []
                            };
                        }
                        workerMaterials[worker.name].count++;
                        workerMaterials[worker.name].materials.push(t.name);
                    }
                }
            });
            
            const sorted = Object.entries(workerMaterials)
                .sort((a, b) => b[1].count - a[1].count);
            
            if (sorted.length === 0) {
                container.innerHTML = '<div class="empty-state-dash">Ning√∫n material asignado actualmente</div>';
                return;
            }
            
            const maxValue = sorted[0][1].count;
            
            container.innerHTML = sorted.map(([name, data]) => {
                const width = (data.count / maxValue * 100);
                return `
                    <div class="chart-bar">
                        <div class="chart-label" title="${name}">${name}</div>
                        <div class="chart-bar-fill" style="width: ${width}%" title="${data.materials.join(', ')}">
                            ${data.count} ${data.count === 1 ? 'material' : 'materiales'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 60) return 'Hace un momento';
            if (seconds < 3600) return `Hace ${Math.floor(seconds / 60)} min`;
            if (seconds < 86400) return `Hace ${Math.floor(seconds / 3600)} h`;
            if (seconds < 604800) return `Hace ${Math.floor(seconds / 86400)} d√≠as`;
            
            return date.toLocaleDateString('es-ES', { day: '2-digit', month: 'short' });
        }

        function dashboardSearch(query) {
            if (!query || query.length < 2) return;
            
            const term = query.toLowerCase();
            
            // Buscar en materiales
            const foundTools = tools.filter(t => 
                t.name.toLowerCase().includes(term) || 
                t.code.toLowerCase().includes(term) ||
                (t.category && t.category.toLowerCase().includes(term)) ||
                (t.location && t.location.toLowerCase().includes(term))
            );
            
            // Buscar en personal
            const foundWorkers = workers.filter(w => 
                w.name.toLowerCase().includes(term) || 
                w.code.toLowerCase().includes(term)
            );
            
            if (foundTools.length > 0) {
                switchTab('tools');
                document.getElementById('searchTools').value = query;
                renderTools(query);
            } else if (foundWorkers.length > 0) {
                switchTab('workers');
                document.getElementById('searchWorkers').value = query;
                renderWorkers(query);
            }
        }

        function showWorkerDetails(workerId) {
            switchTab('workers');
            const worker = workers.find(w => w.id === workerId);
            if (worker) {
                document.getElementById('searchWorkers').value = worker.name;
                renderWorkers(worker.name);
            }
        }

        // ESCANEO QR
        let videoStream = null;
        let scanning = false;

        async function startScanning() {
            try {
                // Verificar si el navegador soporta getUserMedia
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    showNotification('Tu navegador no soporta acceso a la c√°mara. Usa Chrome, Firefox o Safari actualizado.', 'error');
                    return;
                }

                const video = document.getElementById('video');
                const constraints = {
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = videoStream;
                video.style.display = 'block';
                
                document.getElementById('startScanBtn').style.display = 'none';
                document.getElementById('stopScanBtn').style.display = 'block';
                document.getElementById('scanResult').innerHTML = '';
                
                scanning = true;
                
                // Asegurar que el video est√° listo antes de escanear
                video.onloadedmetadata = () => {
                    video.play();
                    scanQRCode();
                };
            } catch (error) {
                console.error('Error de c√°mara:', error);
                
                let errorMessage = '';
                let instructions = '';
                
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorMessage = '‚ùå Permiso de c√°mara denegado';
                    instructions = `
                        <div style="background: #fff3cd; border: 2px solid #ffc107; padding: 15px; border-radius: 10px; margin-top: 15px; text-align: left;">
                            <div style="font-weight: 600; color: #856404; margin-bottom: 10px;">üîß C√≥mo habilitar la c√°mara:</div>
                            <ol style="color: #856404; font-size: 13px; margin-left: 20px; line-height: 1.8;">
                                <li><strong>Chrome Android:</strong><br>
                                    ‚Ä¢ Toca el candado (üîí) en la barra superior<br>
                                    ‚Ä¢ Selecciona "Permisos"<br>
                                    ‚Ä¢ Activa "C√°mara"<br>
                                    ‚Ä¢ Recarga la p√°gina (‚Üª)
                                </li>
                                <li style="margin-top: 10px;"><strong>Si est√°s abriendo desde archivo:</strong><br>
                                    El archivo local (content://) no permite c√°mara por seguridad. Necesitas abrir el archivo desde:<br>
                                    ‚Ä¢ Google Drive (compartir ‚Üí "Abrir con navegador")<br>
                                    ‚Ä¢ Dropbox o OneDrive<br>
                                    ‚Ä¢ Un servidor web
                                </li>
                                <li style="margin-top: 10px;"><strong>Firefox Android:</strong><br>
                                    Firefox es menos restrictivo con archivos locales, intenta abrirlo con Firefox
                                </li>
                            </ol>
                            <div style="margin-top: 10px; padding: 10px; background: #fff; border-radius: 5px; font-size: 12px;">
                                <strong>üí° Soluci√≥n recomendada:</strong> Sube este archivo a Google Drive, √°brelo desde ah√≠ y concede permisos cuando te lo pida.
                            </div>
                        </div>
                    `;
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    errorMessage = '‚ùå No se encontr√≥ c√°mara en el dispositivo';
                    instructions = '<div style="margin-top: 10px; color: #666;">Verifica que tu dispositivo tenga c√°mara disponible.</div>';
                } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                    errorMessage = '‚ùå La c√°mara est√° en uso por otra aplicaci√≥n';
                    instructions = '<div style="margin-top: 10px; color: #666;">Cierra otras apps que puedan estar usando la c√°mara e intenta de nuevo.</div>';
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage = '‚ùå Configuraci√≥n de c√°mara no compatible';
                    instructions = '<div style="margin-top: 10px; color: #666;">Intentando con configuraci√≥n alternativa...</div>';
                    // Reintentar con configuraci√≥n m√°s simple
                    setTimeout(retryWithBasicConstraints, 1000);
                    showNotification(errorMessage, 'error');
                    return;
                } else if (error.name === 'SecurityError') {
                    errorMessage = '‚ùå Error de seguridad';
                    instructions = `
                        <div style="margin-top: 10px; color: #666;">
                            El acceso a la c√°mara requiere una conexi√≥n segura (HTTPS).<br>
                            <strong>Sugerencias:</strong><br>
                            ‚Ä¢ Sube este archivo a un servidor web con HTTPS<br>
                            ‚Ä¢ O usa una herramienta como GitHub Pages o Netlify
                        </div>
                    `;
                } else {
                    errorMessage = '‚ùå Error al acceder a la c√°mara';
                    instructions = `<div style="margin-top: 10px; color: #666;">Detalles: ${error.message}</div>`;
                }
                
                showNotification(errorMessage, 'error');
                
                // Mostrar instrucciones adicionales
                const resultDiv = document.getElementById('scanResult');
                resultDiv.innerHTML = instructions;
            }
        }


        async function retryWithBasicConstraints() {
            try {
                const video = document.getElementById('video');
                const constraints = { video: true }; // Configuraci√≥n b√°sica
                
                showNotification('Intentando con configuraci√≥n b√°sica...', 'success');
                
                videoStream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = videoStream;
                video.style.display = 'block';
                
                document.getElementById('startScanBtn').style.display = 'none';
                document.getElementById('stopScanBtn').style.display = 'block';
                document.getElementById('scanResult').innerHTML = '';
                
                scanning = true;
                
                video.onloadedmetadata = () => {
                    video.play();
                    showNotification('‚úì C√°mara activada correctamente', 'success');
                    scanQRCode();
                };
            } catch (error) {
                showNotification('No se pudo activar la c√°mara. Verifica los permisos.', 'error');
                const resultDiv = document.getElementById('scanResult');
                resultDiv.innerHTML = '<div style="margin-top: 10px; color: #e74c3c;">Por favor, permite el acceso a la c√°mara en la configuraci√≥n de tu navegador.</div>';
            }
        }
        function stopScanning() {
            scanning = false;
            const video = document.getElementById('video');
            
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            
            video.style.display = 'none';
            document.getElementById('startScanBtn').style.display = 'block';
            document.getElementById('stopScanBtn').style.display = 'none';
        }

        function scanQRCode() {
            if (!scanning) return;
            
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const context = canvas.getContext('2d');
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                    handleQRCode(code.data);
                    return;
                }
            }
            
            requestAnimationFrame(scanQRCode);
        }

        function handleQRCode(qrData) {
            stopScanning();
            
            try {
                const data = JSON.parse(qrData);
                
                if (data.type === 'tool') {
                    const tool = tools.find(t => t.id === data.id);
                    if (tool) {
                        showMovementModal(tool);
                    } else {
                        showNotification('Material no encontrado en el sistema', 'error');
                    }
                } else if (data.type === 'worker') {
                    showNotification(`Personal escaneado: ${data.name}`, 'success');
                } else {
                    showNotification('C√≥digo QR no reconocido', 'error');
                }
            } catch (e) {
                showNotification('C√≥digo QR inv√°lido', 'error');
            }
        }

        function showScanResult(message, type) {
            showNotification(message, type);
        }

        function showNotification(message, type = 'success') {
            // Eliminar notificaci√≥n anterior si existe
            const existing = document.querySelector('.notification');
            if (existing) {
                existing.remove();
            }
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icon = type === 'success' ? '‚úì' : '‚úï';
            const iconColor = type === 'success' ? '#27ae60' : '#e74c3c';
            
            notification.innerHTML = `
                <div class="notification-icon" style="color: ${iconColor}; font-size: 20px; font-weight: bold;">
                    ${icon}
                </div>
                <div class="notification-content">${message}</div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 4000);
        }

        function showMovementModal(tool) {
            const modal = document.getElementById('movementModal');
            const title = document.getElementById('movementTitle');
            const content = document.getElementById('movementContent');
            
            if (tool.status === 'available') {
                title.textContent = 'Registrar Salida';
                content.innerHTML = `
                    <div class="tool-card">
                        <div class="tool-name">${tool.name}</div>
                        <div class="tool-info">C√≥digo: ${tool.code}</div>
                    </div>
                    <div class="form-group">
                        <label>Seleccionar personal</label>
                        <select id="selectedWorker">
                            <option value="">-- Seleccionar --</option>
                            ${workers.map(w => `<option value="${w.id}">${w.name} (${w.code})</option>`).join('')}
                        </select>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="closeModal('movementModal')">Cancelar</button>
                        <button class="btn btn-danger" onclick="registerCheckout('${tool.id}')">Registrar Salida</button>
                    </div>
                `;
            } else {
                const worker = workers.find(w => w.id === tool.assignedTo);
                title.textContent = 'Registrar Entrada';
                content.innerHTML = `
                    <div class="tool-card out">
                        <div class="tool-name">${tool.name}</div>
                        <div class="tool-info">C√≥digo: ${tool.code}</div>
                        <div class="tool-info">Asignado a: ${worker ? worker.name : 'Desconocido'}</div>
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-secondary" onclick="closeModal('movementModal')">Cancelar</button>
                        <button class="btn btn-success" onclick="registerCheckin('${tool.id}')">Registrar Entrada</button>
                    </div>
                `;
            }
            
            modal.classList.add('active');
        }

        function registerCheckout(toolId) {
            const workerId = document.getElementById('selectedWorker').value;
            if (!workerId) {
                showNotification('Por favor selecciona un miembro del personal', 'error');
                return;
            }
            
            const tool = tools.find(t => t.id === toolId);
            const worker = workers.find(w => w.id === workerId);
            
            tool.status = 'out';
            tool.assignedTo = workerId;
            
            history.unshift({
                id: Date.now().toString(),
                date: new Date().toISOString(),
                type: 'out',
                toolId: toolId,
                toolName: tool.name,
                workerId: workerId,
                workerName: worker.name
            });
            
            saveData();
            closeModal('movementModal');
            showNotification(`Salida registrada: ${tool.name} ‚Üí ${worker.name}`, 'success');
            renderTools();
            renderDashboard();
        }

        function registerCheckin(toolId) {
            const tool = tools.find(t => t.id === toolId);
            const worker = workers.find(w => w.id === tool.assignedTo);
            
            history.unshift({
                id: Date.now().toString(),
                date: new Date().toISOString(),
                type: 'in',
                toolId: toolId,
                toolName: tool.name,
                workerId: tool.assignedTo,
                workerName: worker ? worker.name : 'Desconocido'
            });
            
            tool.status = 'available';
            tool.assignedTo = null;
            
            saveData();
            closeModal('movementModal');
            showNotification(`Entrada registrada: ${tool.name}`, 'success');
            renderTools();
            renderDashboard();
        }

        // GESTI√ìN DE HERRAMIENTAS
        function renderTools(searchTerm = '') {
            const list = document.getElementById('toolsList');
            
            let filteredTools = tools;
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredTools = tools.filter(t => 
                    t.name.toLowerCase().includes(term) || 
                    t.code.toLowerCase().includes(term) ||
                    (t.category && t.category.toLowerCase().includes(term)) ||
                    (t.description && t.description.toLowerCase().includes(term))
                );
            }
            
            if (filteredTools.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        <p>${searchTerm ? 'No se encontraron materiales' : 'No hay materiales registrados'}</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = filteredTools.map(tool => {
                const worker = tool.assignedTo ? workers.find(w => w.id === tool.assignedTo) : null;
                return `
                    <div class="tool-card ${tool.status}">
                        <div class="tool-name">
                            ${tool.name}
                            ${tool.category ? `<span class="badge badge-category">${tool.category}</span>` : ''}
                        </div>
                        <div class="tool-info">üìù C√≥digo: ${tool.code}</div>
                        ${tool.location ? `<div class="tool-info">üìç Ubicaci√≥n: ${tool.location}</div>` : ''}
                        ${tool.description ? `<div class="tool-info">‚ÑπÔ∏è ${tool.description}</div>` : ''}
                        ${worker ? `<div class="tool-info">üë§ Asignado a: ${worker.name}</div>` : ''}
                        <span class="status-badge ${tool.status === 'available' ? 'status-available' : 'status-out'}">
                            ${tool.status === 'available' ? '‚úì Disponible' : '‚úó En uso'}
                        </span>
                        <div class="action-buttons">
                            <button class="btn btn-small btn-icon" onclick="showQR('tool', '${tool.id}')">
                                üì± Ver QR
                            </button>
                            <button class="btn btn-small btn-icon ${tool.status === 'available' ? 'btn-danger' : 'btn-success'}" onclick="quickMovement('${tool.id}')">
                                ${tool.status === 'available' ? 'üì§ Prestar' : 'üì• Devolver'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function searchTools() {
            const searchTerm = document.getElementById('searchTools').value;
            renderTools(searchTerm);
        }

        function quickMovement(toolId) {
            const tool = tools.find(t => t.id === toolId);
            if (!tool) return;
            
            if (tool.status === 'available') {
                // Mostrar modal para salida
                showMovementModal(tool);
            } else {
                // Entrada directa
                registerCheckin(toolId);
            }
        }

        function showAddToolModal() {
            document.getElementById('toolName').value = '';
            document.getElementById('toolCode').value = '';
            document.getElementById('toolCategory').value = '';
            document.getElementById('toolLocation').value = '';
            document.getElementById('toolDescription').value = '';
            document.getElementById('addToolModal').classList.add('active');
        }

        function addTool() {
            const name = document.getElementById('toolName').value.trim();
            const code = document.getElementById('toolCode').value.trim();
            const category = document.getElementById('toolCategory').value.trim();
            const location = document.getElementById('toolLocation').value.trim();
            const description = document.getElementById('toolDescription').value.trim();
            
            if (!name || !code) {
                showNotification('Por favor completa los campos obligatorios', 'error');
                return;
            }
            
            const tool = {
                id: Date.now().toString(),
                name,
                code,
                category,
                location,
                description,
                status: 'available',
                assignedTo: null
            };
            
            tools.push(tool);
            saveData();
            closeModal('addToolModal');
            showNotification(`Material "${name}" a√±adido correctamente`, 'success');
            renderTools();
            renderDashboard();
        }

        // GESTI√ìN DE TRABAJADORES
        function renderWorkers(searchTerm = '') {
            const list = document.getElementById('workersList');
            
            let filteredWorkers = workers;
            if (searchTerm) {
                const term = searchTerm.toLowerCase();
                filteredWorkers = workers.filter(w => 
                    w.name.toLowerCase().includes(term) || 
                    w.code.toLowerCase().includes(term) ||
                    (w.department && w.department.toLowerCase().includes(term))
                );
            }
            
            if (filteredWorkers.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        <p>${searchTerm ? 'No se encontr√≥ personal' : 'No hay personal registrado'}</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = filteredWorkers.map(worker => {
                const assignedTools = tools.filter(t => t.assignedTo === worker.id);
                return `
                    <div class="worker-card">
                        <div class="tool-name">${worker.name}</div>
                        <div class="tool-info">üìã Empleado: ${worker.code}</div>
                        ${worker.department ? `<div class="tool-info">üè¢ Departamento: ${worker.department}</div>` : ''}
                        ${worker.phone ? `<div class="tool-info">üìû Tel√©fono: ${worker.phone}</div>` : ''}
                        ${worker.email ? `<div class="tool-info">üìß Email: ${worker.email}</div>` : ''}
                        <div class="tool-info">üì¶ Materiales: ${assignedTools.length}</div>
                        ${assignedTools.length > 0 ? `
                            <div style="margin-top: 5px; font-size: 13px; color: #666;">
                                ${assignedTools.map(t => t.name).join(', ')}
                            </div>
                        ` : ''}
                        <div style="margin-top: 10px;">
                            <button class="btn" style="font-size: 12px; padding: 8px 15px;" onclick="showQR('worker', '${worker.id}')">
                                üì± Ver QR
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function searchWorkers() {
            const searchTerm = document.getElementById('searchWorkers').value;
            renderWorkers(searchTerm);
        }

        function showAddWorkerModal() {
            document.getElementById('workerName').value = '';
            document.getElementById('workerCode').value = '';
            document.getElementById('workerDepartment').value = '';
            document.getElementById('workerPhone').value = '';
            document.getElementById('workerEmail').value = '';
            document.getElementById('addWorkerModal').classList.add('active');
        }

        function addWorker() {
            const name = document.getElementById('workerName').value.trim();
            const code = document.getElementById('workerCode').value.trim();
            const department = document.getElementById('workerDepartment').value.trim();
            const phone = document.getElementById('workerPhone').value.trim();
            const email = document.getElementById('workerEmail').value.trim();
            
            if (!name || !code) {
                showNotification('Por favor completa todos los campos', 'error');
                return;
            }
            
            const worker = {
                id: Date.now().toString(),
                name,
                code,
                department,
                phone,
                email
            };
            
            workers.push(worker);
            saveData();
            closeModal('addWorkerModal');
            showNotification(`Personal "${name}" a√±adido correctamente`, 'success');
            renderWorkers();
            renderDashboard();
        }

        // HISTORIAL
        let filteredHistory = [];

        function renderHistory() {
            const list = document.getElementById('historyList');
            
            // Actualizar opciones de filtro de personal
            const filterWorker = document.getElementById('filterWorker');
            filterWorker.innerHTML = '<option value="">Todo el personal</option>';
            workers.forEach(w => {
                filterWorker.innerHTML += `<option value="${w.id}">${w.name}</option>`;
            });
            
            // Renderizar estad√≠sticas
            renderStats();
            
            // Aplicar filtros
            filteredHistory = [...history];
            
            if (filteredHistory.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                        </svg>
                        <p>No hay movimientos registrados</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = filteredHistory.map(item => {
                const date = new Date(item.date);
                const dateStr = date.toLocaleDateString('es-ES', { 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric'
                });
                const timeStr = date.toLocaleTimeString('es-ES', { 
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const icon = item.type === 'out' ? 'üì§' : 'üì•';
                const actionText = item.type === 'out' ? 'Salida' : 'Entrada';
                
                return `
                    <div class="history-item history-${item.type}">
                        <div class="history-date">
                            <span class="date-badge">${dateStr}</span>
                            <span class="time-badge">${timeStr}</span>
                        </div>
                        <div class="history-action">
                            ${icon} ${actionText}: ${item.toolName}
                        </div>
                        <div class="tool-info">üë§ ${item.workerName}</div>
                    </div>
                `;
            }).join('');
        }

        function renderStats() {
            const statsContainer = document.getElementById('statsContainer');
            
            const totalMovements = history.length;
            const totalOut = history.filter(h => h.type === 'out').length;
            const totalIn = history.filter(h => h.type === 'in').length;
            const toolsInUse = tools.filter(t => t.status === 'out').length;
            
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${totalMovements}</div>
                    <div class="stat-label">Total Movimientos</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);">
                    <div class="stat-number">${totalOut}</div>
                    <div class="stat-label">Salidas</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #27ae60 0%, #229954 100%);">
                    <div class="stat-number">${totalIn}</div>
                    <div class="stat-label">Entradas</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);">
                    <div class="stat-number">${toolsInUse}</div>
                    <div class="stat-label">En uso ahora</div>
                </div>
            `;
        }

        function applyFilters() {
            const dateFrom = document.getElementById('filterDateFrom').value;
            const dateTo = document.getElementById('filterDateTo').value;
            const filterType = document.getElementById('filterType').value;
            const filterWorker = document.getElementById('filterWorker').value;
            
            filteredHistory = [...history];
            
            // Filtrar por fecha desde
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                fromDate.setHours(0, 0, 0, 0);
                filteredHistory = filteredHistory.filter(h => {
                    const itemDate = new Date(h.date);
                    itemDate.setHours(0, 0, 0, 0);
                    return itemDate >= fromDate;
                });
            }
            
            // Filtrar por fecha hasta
            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999);
                filteredHistory = filteredHistory.filter(h => {
                    const itemDate = new Date(h.date);
                    return itemDate <= toDate;
                });
            }
            
            // Filtrar por tipo
            if (filterType) {
                filteredHistory = filteredHistory.filter(h => h.type === filterType);
            }
            
            // Filtrar por trabajador
            if (filterWorker) {
                filteredHistory = filteredHistory.filter(h => h.workerId === filterWorker);
            }
            
            // Re-renderizar
            const list = document.getElementById('historyList');
            if (filteredHistory.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <p>No hay movimientos que coincidan con los filtros</p>
                    </div>
                `;
                return;
            }
            
            list.innerHTML = filteredHistory.map(item => {
                const date = new Date(item.date);
                const dateStr = date.toLocaleDateString('es-ES', { 
                    day: '2-digit', 
                    month: 'short', 
                    year: 'numeric'
                });
                const timeStr = date.toLocaleTimeString('es-ES', { 
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                const icon = item.type === 'out' ? 'üì§' : 'üì•';
                const actionText = item.type === 'out' ? 'Salida' : 'Entrada';
                
                return `
                    <div class="history-item history-${item.type}">
                        <div class="history-date">
                            <span class="date-badge">${dateStr}</span>
                            <span class="time-badge">${timeStr}</span>
                        </div>
                        <div class="history-action">
                            ${icon} ${actionText}: ${item.toolName}
                        </div>
                        <div class="tool-info">üë§ ${item.workerName}</div>
                    </div>
                `;
            }).join('');
        }

        function exportHistory() {
            if (history.length === 0) {
                showNotification('No hay datos para exportar', 'error');
                return;
            }

            // Asegurarse de que XLSX est√° disponible
            if (typeof XLSX === 'undefined') {
                showNotification('Cargando librer√≠a Excel, espera...', 'success');
                const s = document.createElement('script');
                s.src = 'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js';
                s.onload = () => exportHistory();
                document.head.appendChild(s);
                return;
            }

            try {
                const now = new Date();
                const fechaHoy = now.toLocaleDateString('es-ES');
                const horaAhora = now.toLocaleTimeString('es-ES');

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // HOJA 1 ‚Äî RESUMEN EJECUTIVO
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                const totalOut  = history.filter(h => h.type === 'out').length;
                const totalIn   = history.filter(h => h.type === 'in').length;
                const inUse     = tools.filter(t => t.status === 'out').length;
                const available = tools.filter(t => t.status === 'available').length;
                const pctUso    = tools.length > 0 ? ((inUse / tools.length) * 100).toFixed(1) + '%' : '0%';

                const matUsage  = {};
                history.forEach(h => { if (h.type === 'out') matUsage[h.toolName] = (matUsage[h.toolName] || 0) + 1; });
                const topMat    = Object.entries(matUsage).sort((a, b) => b[1] - a[1]).slice(0, 5);

                const persUsage = {};
                history.forEach(h => { persUsage[h.workerName] = (persUsage[h.workerName] || 0) + 1; });
                const topPers   = Object.entries(persUsage).sort((a, b) => b[1] - a[1]).slice(0, 5);

                const resumenData = [
                    ['ISIVOLTPRO - REPORTE EJECUTIVO'],
                    [`Empresa: IsivoltPro  |  Generado: ${fechaHoy} ${horaAhora}`],
                    [''],
                    ['M√âTRICAS GENERALES', 'Valor'],
                    ['Total materiales registrados', tools.length],
                    ['Materiales disponibles', available],
                    ['Materiales en uso', inUse],
                    ['% Uso de inventario', pctUso],
                    ['Total personal registrado', workers.length],
                    ['Total movimientos hist√≥ricos', history.length],
                    ['Total salidas registradas', totalOut],
                    ['Total entradas registradas', totalIn],
                    [''],
                    ['TOP 5 MATERIALES M√ÅS USADOS', 'N¬∫ Salidas'],
                    ...topMat.map(([name, count]) => [name, count]),
                    [''],
                    ['TOP 5 PERSONAL M√ÅS ACTIVO', 'N¬∫ Movimientos'],
                    ...topPers.map(([name, count]) => [name, count]),
                ];

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // HOJA 2 ‚Äî HISTORIAL COMPLETO
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                const diasSemana = ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];

                const historialData = [
                    ['HISTORIAL DE MOVIMIENTOS - IsivoltPro'],
                    [`Exportado: ${fechaHoy} ${horaAhora}  |  Total registros: ${filteredHistory.length}`],
                    [''],
                    ['N¬∫', 'Fecha', 'Hora', 'D√≠a Semana', 'Tipo', 'Material', 'C√≥d. Material', 'Ubicaci√≥n', 'Responsable', 'C√≥d. Empleado', 'Departamento'],
                ];

                filteredHistory.forEach((item, i) => {
                    const d       = new Date(item.date);
                    const worker  = workers.find(w => w.id === item.workerId);
                    const tool    = tools.find(t => t.id === item.toolId);
                    historialData.push([
                        i + 1,
                        d.toLocaleDateString('es-ES'),
                        d.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                        diasSemana[d.getDay()],
                        item.type === 'out' ? 'SALIDA' : 'ENTRADA',
                        item.toolName || '-',
                        tool   ? (tool.code       || '-') : '-',
                        tool   ? (tool.location   || '-') : '-',
                        item.workerName || '-',
                        worker ? (worker.code     || '-') : '-',
                        worker ? (worker.department || '-') : '-',
                    ]);
                });

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // HOJA 3 ‚Äî INVENTARIO ACTUAL
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                const inventarioData = [
                    ['INVENTARIO ACTUAL - IsivoltPro'],
                    [`Fecha: ${fechaHoy}  |  Total materiales: ${tools.length}`],
                    [''],
                    ['N¬∫', 'Nombre Material', 'C√≥digo', 'Categor√≠a', 'Ubicaci√≥n', 'Descripci√≥n', 'Estado', 'Asignado A', 'C√≥d. Empleado', 'Departamento', 'Tel√©fono'],
                ];

                tools.forEach((tool, i) => {
                    const worker = tool.assignedTo ? workers.find(w => w.id === tool.assignedTo) : null;
                    inventarioData.push([
                        i + 1,
                        tool.name,
                        tool.code,
                        tool.category   || '-',
                        tool.location   || '-',
                        tool.description || '-',
                        tool.status === 'available' ? 'DISPONIBLE' : 'EN USO',
                        worker ? worker.name       : '-',
                        worker ? (worker.code      || '-') : '-',
                        worker ? (worker.department || '-') : '-',
                        worker ? (worker.phone      || '-') : '-',
                    ]);
                });

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // HOJA 4 ‚Äî PERSONAL
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                const personalData = [
                    ['LISTADO DE PERSONAL - IsivoltPro'],
                    [`Fecha: ${fechaHoy}  |  Total personal: ${workers.length}`],
                    [''],
                    ['N¬∫', 'Nombre Completo', 'C√≥d. Empleado', 'Departamento', 'Tel√©fono', 'Email', 'Materiales Asignados', 'Lista de Materiales'],
                ];

                workers.forEach((worker, i) => {
                    const assigned = tools.filter(t => t.assignedTo === worker.id);
                    personalData.push([
                        i + 1,
                        worker.name,
                        worker.code,
                        worker.department || '-',
                        worker.phone      || '-',
                        worker.email      || '-',
                        assigned.length,
                        assigned.map(t => t.name).join(' | ') || 'Ninguno',
                    ]);
                });

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // HOJA 5 ‚Äî MATERIALES EN USO AHORA
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                const enUsoData = [
                    ['MATERIALES EN USO AHORA - IsivoltPro'],
                    [`Fecha: ${fechaHoy}  |  En uso: ${inUse} de ${tools.length}`],
                    [''],
                    ['N¬∫', 'Material', 'C√≥digo', 'Categor√≠a', 'Ubicaci√≥n', 'Asignado A', 'Tel√©fono', 'Departamento', 'Fecha Salida', 'D√≠as En Uso'],
                ];

                let counter = 1;
                tools.filter(t => t.status === 'out').forEach(tool => {
                    const worker = tool.assignedTo ? workers.find(w => w.id === tool.assignedTo) : null;
                    // Buscar la √∫ltima salida de este material en el historial
                    const lastOut = [...history].find(h => h.toolId === tool.id && h.type === 'out');
                    let fechaSalida = '-';
                    let diasEnUso = '-';
                    if (lastOut) {
                        const dOut = new Date(lastOut.date);
                        fechaSalida = dOut.toLocaleDateString('es-ES') + ' ' + dOut.toLocaleTimeString('es-ES', {hour:'2-digit',minute:'2-digit'});
                        diasEnUso = Math.floor((now - dOut) / (1000 * 60 * 60 * 24));
                    }
                    enUsoData.push([
                        counter++,
                        tool.name,
                        tool.code,
                        tool.category    || '-',
                        tool.location    || '-',
                        worker ? worker.name        : '-',
                        worker ? (worker.phone      || '-') : '-',
                        worker ? (worker.department || '-') : '-',
                        fechaSalida,
                        diasEnUso,
                    ]);
                });

                if (counter === 1) enUsoData.push(['No hay materiales en uso actualmente']);

                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                // CONSTRUIR LIBRO EXCEL
                // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                const wb = XLSX.utils.book_new();

                const addSheet = (data, widths, name) => {
                    const ws = XLSX.utils.aoa_to_sheet(data);
                    ws['!cols'] = widths.map(w => ({ wch: w }));
                    XLSX.utils.book_append_sheet(wb, ws, name);
                };

                addSheet(resumenData,   [38, 20],                                        'Resumen');
                addSheet(historialData, [5,12,8,12,10,26,14,20,22,14,16],               'Historial');
                addSheet(inventarioData,[5,26,14,18,20,22,12,22,14,15,14],              'Inventario');
                addSheet(personalData,  [5,24,14,16,14,28,10,45],                       'Personal');
                addSheet(enUsoData,     [5,26,14,16,20,22,14,16,18,10],                 'En Uso Ahora');

                // Nombre del archivo
                const fechaFile = fechaHoy.replace(/\//g, '-');
                XLSX.writeFile(wb, `IsivoltPro_Reporte_${fechaFile}.xlsx`);

                showNotification(`‚úÖ Excel descargado con 5 hojas (${filteredHistory.length} movimientos)`, 'success');

            } catch (error) {
                console.error('Error Excel:', error);
                exportCSVFallback();
            }
        }

        function exportCSVFallback() {
            // CSV con BOM para que Excel lo lea bien en espa√±ol
            const BOM = '\uFEFF';
            let csv = BOM + 'N¬∫;Fecha;Hora;Tipo;Material;C√≥digo;Ubicaci√≥n;Responsable;Empleado;Departamento\n';

            const dataToExport = filteredHistory.length > 0 ? filteredHistory : history;

            dataToExport.forEach((item, index) => {
                const date   = new Date(item.date);
                const worker = workers.find(w => w.id === item.workerId);
                const tool   = tools.find(t => t.id === item.toolId);
                csv += [
                    index + 1,
                    date.toLocaleDateString('es-ES'),
                    date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                    item.type === 'out' ? 'SALIDA' : 'ENTRADA',
                    `"${item.toolName || ''}"`,
                    tool   ? tool.code             : '',
                    tool   ? (tool.location || '') : '',
                    `"${item.workerName || ''}"`,
                    worker ? worker.code            : '',
                    worker ? (worker.department || '') : ''
                ].join(';') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url  = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href  = url;
            link.download = `IsivoltPro_${new Date().toLocaleDateString('es-ES').replace(/\//g,'-')}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            showNotification('‚úÖ CSV descargado ‚Äî √Åbrelo con Excel', 'success');
        }

        // C√ìDIGOS QR
        function showQR(type, id) {
            const modal   = document.getElementById('qrModal');
            const content = document.getElementById('qrContent');

            let data, item;
            if (type === 'tool') {
                item = tools.find(t => t.id === id);
                if (!item) { showNotification('Material no encontrado', 'error'); return; }
                data = { type: 'tool', id: item.id, name: item.name, code: item.code };
            } else {
                item = workers.find(w => w.id === id);
                if (!item) { showNotification('Personal no encontrado', 'error'); return; }
                data = { type: 'worker', id: item.id, name: item.name, code: item.code };
            }

            content.innerHTML = `
                <div class="qr-container">
                    <div style="font-weight:700; font-size:18px; margin-bottom:4px; color:#1e3c72;">${item.name}</div>
                    <div style="color:#888; font-size:13px; margin-bottom:16px;">üìù ${item.code}</div>
                    <div id="qrcode-wrapper" style="display:flex;justify-content:center;align-items:center;min-height:270px;">
                        <span style="color:#aaa;">‚è≥ Generando QR...</span>
                    </div>
                    <p style="margin-top:12px; font-size:12px; color:#999; text-align:center;">
                        Escanea para registrar movimientos
                    </p>
                    <div style="display:flex; gap:10px; margin-top:14px;">
                        <button class="btn btn-success" onclick="downloadQR('${item.name}')" style="flex:1;padding:12px;font-size:13px;">
                            üíæ Descargar
                        </button>
                        <button class="btn btn-secondary" onclick="printQR('${item.name}','${item.code}')" style="flex:1;padding:12px;font-size:13px;">
                            üñ®Ô∏è Imprimir
                        </button>
                    </div>
                </div>
            `;

            modal.classList.add('active');

            setTimeout(() => {
                const wrapper = document.getElementById('qrcode-wrapper');
                if (!wrapper) return;
                const canvas = document.createElement('canvas');
                canvas.id = 'qrcode-canvas';
                canvas.style.borderRadius = '8px';
                wrapper.innerHTML = '';
                wrapper.appendChild(canvas);

                QRCode.toCanvas(canvas, JSON.stringify(data), {
                    width: 260, margin: 2,
                    color: { dark: '#1e3c72', light: '#ffffff' },
                    errorCorrectionLevel: 'M'
                }, err => {
                    if (err) {
                        wrapper.innerHTML = `
                            <div style="color:#e74c3c;padding:20px;text-align:center;">
                                ‚ùå Error al generar QR<br>
                                <small>${err.message}</small><br><br>
                                <button class="btn" onclick="showQR('${type}','${id}')">üîÑ Reintentar</button>
                            </div>`;
                    }
                });
            }, 120);
        }

        function downloadQR(name) {
            const canvas = document.getElementById('qrcode-canvas');
            if (!canvas) { showNotification('QR a√∫n gener√°ndose, espera un momento', 'error'); return; }
            const link = document.createElement('a');
            link.download = `QR-${name.replace(/\s+/g,'-')}.png`;
            link.href = canvas.toDataURL('image/png');
            link.click();
            showNotification(`QR de "${name}" descargado`, 'success');
        }

        function printQR(name, code) {
            const canvas = document.getElementById('qrcode-canvas');
            if (!canvas) { showNotification('QR a√∫n gener√°ndose, espera un momento', 'error'); return; }
            const img = canvas.toDataURL('image/png');
            const w = window.open('', '_blank');
            w.document.write(`<!DOCTYPE html><html><head><title>QR ${name}</title>
                <style>
                    body{font-family:Arial,sans-serif;text-align:center;padding:40px;background:#fff;}
                    img{width:250px;height:250px;border:3px solid #1e3c72;border-radius:10px;}
                    h2{color:#1e3c72;margin:15px 0 5px;}
                    p{color:#666;font-size:14px;margin:4px 0;}
                    .logo{font-size:22px;font-weight:700;color:#1e3c72;margin-bottom:15px;}
                    .footer{margin-top:15px;font-size:11px;color:#aaa;}
                    @media print{.no-print{display:none!important;}}
                </style></head>
                <body>
                    <div class="logo">‚ö° IsivoltPro</div>
                    <img src="${img}" alt="QR">
                    <h2>${name}</h2>
                    <p>üìù C√≥digo: ${code}</p>
                    <p class="footer">Escanea este c√≥digo en IsivoltPro para registrar entrada/salida</p>
                    <br>
                    <button class="no-print" onclick="window.print()" 
                        style="margin-top:10px;padding:12px 28px;background:#1e3c72;color:white;border:none;border-radius:8px;font-size:16px;cursor:pointer;">
                        üñ®Ô∏è Imprimir
                    </button>
                </body></html>`);
            w.document.close();
        }

        // Descargar la propia app HTML (para m√≥viles de empresa sin instalaci√≥n)
        function downloadApp() {
            const html = document.documentElement.outerHTML;
            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            const url  = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'IsivoltPro.html';
            link.click();
            URL.revokeObjectURL(url);
            showNotification('App descargada. √Åbrela desde Google Drive para usar la c√°mara', 'success');
        }

        // UTILIDADES
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Cerrar modales al hacer clic fuera
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Renderizar al cargar
        renderDashboard();
        renderTools();
    </script>
</body>
</html>