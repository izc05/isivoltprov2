<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b132b" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <title>IsiVolt Pro Â· Legionella</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <div class="bg-blob blob-a"></div>
  <div class="bg-blob blob-b"></div>
  <div class="bg-sheen"></div>

  <!-- TOPBAR -->
  <header class="topbar glass">
    <div class="brand">
      <div class="logo">âš¡</div>
      <div>
        <div class="title">IsiVolt Pro</div>
        <div class="subtitle">Legionella Control (PWA)</div>
      </div>
    </div>
    <div class="hdr-btns">
      <button id="btnGuide" class="btn btn-icon" title="GuÃ­a rÃ¡pida">ğŸ§</button>
      <button id="btnSettings" class="btn btn-icon" title="Ajustes">âš™ï¸</button>
    </div>
  </header>

  <main class="container">

    <!-- â•â•â•â•â•â•â•â•â•â•â• PERFIL â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="screenProfile" class="screen">
      <div class="card glass">
        <h1>Bienvenido a IsiVolt Pro</h1>
        <p class="muted">Introduce tu nombre de tÃ©cnico. Los datos se guardan localmente en este dispositivo.</p>
        <div class="col" style="gap:10px;margin-top:16px">
          <input id="techName" class="input" placeholder="Nombre tÃ©cnico (ej: Paco)" maxlength="18" />
          <button id="btnSetTech" class="btn btn-primary btn-lg">Entrar â†’</button>
        </div>
        <div class="divider"></div>
        <p class="muted tiny">Consejo: usa el mismo nombre siempre en el mismo mÃ³vil para mantener el historial limpio.</p>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â• HOME â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="screenHome" class="screen hidden">
      <div class="grid">

        <div class="card glass">
          <div class="kpi">
            <div>
              <div class="muted tiny">TÃ©cnico activo</div>
              <div id="kpiTech" class="kpi-value">â€”</div>
            </div>
            <div class="row" style="gap:6px">
              <button id="btnSwitchTech" class="btn btn-ghost btn-sm">Cambiar</button>
              <button id="btnLogout" class="btn btn-danger btn-sm">Cerrar</button>
            </div>
          </div>
          <div class="kpi" style="margin-top:12px">
            <div>
              <div class="muted tiny">OT de hoy</div>
              <div id="kpiToday" class="kpi-value">0 / 0</div>
            </div>
            <div class="pill" id="pillOffline">â€”</div>
          </div>
        </div>

        <div class="card glass">
          <h2>Acciones rÃ¡pidas</h2>
          <div class="actions">
            <button id="btnScan" class="btn btn-primary">ğŸ“· Escanear QR</button>
            <button id="btnAddCode" class="btn btn-primary">â• AÃ±adir punto</button>
            <button id="btnMonthly" class="btn btn-ghost">ğŸ§ª Informe mensual</button>
            <button id="btnHistory" class="btn btn-ghost">ğŸ•˜ Historial</button>
          </div>
          <div class="divider"></div>
          <div class="row" style="gap:6px;flex-wrap:wrap">
            <button id="btnExplainOT" class="btn btn-ghost btn-sm">â„¹ï¸ Â¿QuÃ© es OT?</button>
            <button id="btnClearOT" class="btn btn-danger btn-sm">ğŸ—‘ï¸ Vaciar OT</button>
          </div>
          <p class="muted tiny" style="margin-top:10px">Crea la lista en el taller y ve cerrando en campo.</p>
        </div>

        <div class="card glass" style="grid-column:1/-1">
          <h2>OT de hoy</h2>
          <div id="otList" class="list"></div>
          <div id="otEmpty" class="empty muted">Sin puntos. AÃ±ade con QR o cÃ³digo.</div>
        </div>

      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â• SCAN â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="screenScan" class="screen hidden">
      <div class="card glass">
        <div class="row space-between">
          <h2 id="scanTitle">Escanear QR</h2>
          <button class="btn btn-icon" data-nav="home">âœ–</button>
        </div>
        <div class="muted tiny" id="scanHint">Si tu mÃ³vil no soporta escaneo nativo, usa el campo inferior.</div>
        <div class="scanbox">
          <video id="qrVideo" playsinline></video>
          <div class="scan-overlay"></div>
        </div>
        <div class="row">
          <button id="btnStartScan" class="btn btn-primary" style="flex:1">Iniciar cÃ¡mara</button>
          <button id="btnStopScan" class="btn btn-ghost">Detener</button>
        </div>
        <div class="divider"></div>
        <div class="row">
          <input id="manualCodeFromScan" class="input" placeholder="O escribe cÃ³digo" />
          <button id="btnManualGo" class="btn">AÃ±adir</button>
        </div>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â• PUNTO â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="screenPoint" class="screen hidden">
      <div class="card glass">
        <div class="row space-between">
          <div>
            <div class="muted tiny">Punto / UbicaciÃ³n</div>
            <div id="pointCode" class="bigcode">â€”</div>
            <div id="pointHotelDisplay" class="muted" style="font-size:13px;margin-top:2px"></div>
          </div>
          <div class="row" style="gap:6px">
            <button id="btnEditCode" class="btn btn-icon" title="Editar cÃ³digo">âœï¸</button>
            <button class="btn btn-icon" data-nav="home">â¬…</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid2">

          <div class="panel glass-lite">
            <h3>ğŸ“Š Calculadora</h3>

            <label class="label">Hotel / UbicaciÃ³n (opcional)</label>
            <input id="hotelName" class="input" placeholder="Ej: Hotel MeliÃ¡ Â· Planta 3" maxlength="60" />

            <label class="label">Litros de agua</label>
            <div class="row">
              <input id="liters" class="input" type="number" inputmode="decimal" min="0" step="1" placeholder="Ej: 60" />
              <button id="btnUseDefaultLiters" class="btn btn-ghost btn-sm">60 L</button>
            </div>

            <div class="calc-result" style="margin-top:12px">
              <div class="muted tiny">Dosis estimada</div>
              <div id="doseMl" class="dose">â€”</div>
              <div class="muted tiny">ml de lejÃ­a Â· queda registrada al finalizar</div>
            </div>

            <label class="label" style="margin-top:12px">Tiempo objetivo (min)</label>
            <div class="row">
              <input id="targetMinutes" class="input" type="number" min="1" step="1" />
              <button id="btnTimeAuto" class="btn btn-ghost btn-sm">Auto</button>
            </div>

            <label class="label">ObservaciÃ³n (opcional)</label>
            <textarea id="pointNote" class="input textarea" rows="2" placeholder="Sin retorno / Puerta cerradaâ€¦"></textarea>

            <div class="col" style="gap:8px;margin-top:14px">
              <button id="btnStartTimer" class="btn btn-primary btn-lg">â± Iniciar cronÃ³metro</button>
              <div class="row" style="gap:8px">
                <button id="btnSaveNote" class="btn btn-ghost" style="flex:1">ğŸ’¾ Guardar nota</button>
                <button id="btnMarkIssue" class="btn btn-danger" style="flex:1">âš  Incidencia</button>
              </div>
            </div>
          </div>

          <div class="panel glass-lite">
            <h3>âœ… Checklist</h3>
            <div class="checklist">
              <label><input type="checkbox" id="chkConnect" /> Conectar recirculaciÃ³n</label>
              <label><input type="checkbox" id="chkReturn" /> Verificar retorno</label>
              <label><input type="checkbox" id="chkDose" /> AÃ±adir dosis</label>
              <label><input type="checkbox" id="chkStart" /> Iniciar recirculaciÃ³n</label>
            </div>
            <div class="divider thin"></div>
            <div class="muted tiny">Al finalizar se registra en historial con fecha/hora automÃ¡ticamente.</div>
          </div>

        </div>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â• TIMER â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="screenTimer" class="screen hidden">
      <div class="card glass center">
        <div class="row space-between">
          <div style="text-align:left">
            <div class="muted tiny">En proceso</div>
            <div id="timerCode" class="bigcode">â€”</div>
            <div id="timerHotel" class="muted" style="font-size:13px;margin-top:2px"></div>
          </div>
          <div class="row" style="gap:6px">
            <button id="btnMinimizeTimer" class="btn btn-ghost btn-sm" title="Minimizar y volver">â–¼ Minimizar</button>
            <button id="btnExitTimer" class="btn btn-icon" title="Ir a inicio">ğŸ </button>
          </div>
        </div>

        <div class="timer-tank">
          <div class="water" id="waterFill"></div>
          <div class="tank-glass"></div>
          <div class="timer-overlay">
            <div id="timerLeft" class="timer-left">00:00</div>
            <div class="muted tiny" id="timerTarget">Objetivo: â€”</div>
          </div>
        </div>

        <div class="row center" style="gap:8px;flex-wrap:wrap">
          <button id="btnPause" class="btn btn-ghost">â¸ Pausar</button>
          <button id="btnResume" class="btn btn-ghost hidden">â–¶ Reanudar</button>
          <button id="btnFinish" class="btn btn-primary">âœ… Finalizar</button>
        </div>

        <div class="divider"></div>
        <div id="sealDone" class="seal hidden">âœ” TRATAMIENTO COMPLETADO</div>
        <div id="sealWarn" class="seal seal-warn hidden">âš  MARCADO CON INCIDENCIA</div>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â• HISTORIAL â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="screenHistory" class="screen hidden">
      <div class="card glass">
        <div class="row space-between">
          <h2>Historial</h2>
          <button class="btn btn-icon" data-nav="home">â¬…</button>
        </div>
        <div class="row" style="gap:8px;flex-wrap:wrap">
          <button id="btnExport" class="btn">ğŸ“¤ Exportar JSON</button>
          <button id="btnImport" class="btn btn-ghost">ğŸ“¥ Importar</button>
          <input id="fileImport" type="file" accept="application/json" class="hidden" />
        </div>
        <div class="divider"></div>
        <div id="historyList" class="list"></div>
        <div id="historyEmpty" class="empty muted">Sin registros aÃºn.</div>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â• MENSUAL â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="screenMonthly" class="screen hidden">
      <div class="card glass">
        <div class="row space-between">
          <h2>Informe mensual Â· Muestras</h2>
          <button class="btn btn-icon" data-nav="home">â¬…</button>
        </div>
        <div class="muted tiny">Crea la ruta del mes por plantas (-1, Baja, 1Âªâ€“8Âª). Exterior/Parking: <b>NO APLICA</b>.</div>

        <div class="divider"></div>

        <div class="kpi kpi-2">
          <div>
            <div class="muted tiny">Mes</div>
            <div id="kpiMonth" class="kpi-value">â€”</div>
          </div>
          <div>
            <div class="muted tiny">Progreso</div>
            <div id="kpiMonthDone" class="kpi-value">0 / 0</div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="grid2">
          <div class="panel glass-lite">
            <h3>Cabecera</h3>
            <label class="label">Fecha muestreo</label>
            <input id="monthSampleDate" class="input" type="date" />
            <label class="label">TÃ©cnico asignado</label>
            <input id="monthAssignedTech" class="input" placeholder="Ej: Paco" maxlength="18" />
            <label class="label">ObservaciÃ³n general</label>
            <textarea id="monthHeaderNote" class="input textarea" rows="2" placeholder="Ej: ruta parcialâ€¦"></textarea>
            <div class="row" style="margin-top:10px;gap:8px">
              <button id="btnSaveMonthlyHeader" class="btn btn-primary" style="flex:1">Guardar cabecera</button>
              <button id="btnMonthlyExport" class="btn" style="flex:1">ğŸ“¤ Exportar</button>
            </div>
          </div>

          <div class="panel glass-lite">
            <h3>Documento (ref.)</h3>
            <div class="row" style="gap:8px">
              <button id="btnMonthlyAttach" class="btn" style="flex:1">ğŸ“ Adjuntar</button>
              <button id="btnMonthlyOpen" class="btn btn-ghost" style="flex:1">ğŸ“„ Abrir</button>
              <input id="monthlyFile" type="file" accept="application/pdf,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" class="hidden" />
            </div>
            <div class="divider thin"></div>
            <h3>Crear ruta</h3>
            <label class="label">Planta por defecto</label>
            <select id="monthlyPlantDefault" class="input">
              <option value="Baja">Baja</option>
              <option value="1Âª">1Âª</option><option value="2Âª">2Âª</option>
              <option value="3Âª">3Âª</option><option value="4Âª">4Âª</option>
              <option value="5Âª">5Âª</option><option value="6Âª">6Âª</option>
              <option value="7Âª">7Âª</option><option value="8Âª">8Âª</option>
              <option value="-1">-1</option>
              <option value="Otros">Otros</option>
            </select>
            <div class="actions" style="margin-top:10px">
              <button id="btnMonthlyScanHot" class="btn btn-primary">ğŸ”¥ Escanear ACS</button>
              <button id="btnMonthlyScanCold" class="btn btn-primary">â„ï¸ Escanear AFCH</button>
              <button id="btnMonthlyAdd" class="btn">â• AÃ±adir punto</button>
              <button id="btnMonthlyShowEmpty" class="btn btn-ghost">ğŸ‘ï¸ VacÃ­as: OFF</button>
              <button id="btnMonthlyClear" class="btn btn-danger">ğŸ—‘ï¸ Vaciar</button>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row" style="gap:6px;flex-wrap:wrap">
          <span class="badge todo">â³ Pendiente</span>
          <span class="badge ok">âœ… Hecho</span>
          <span class="badge issue">âš  Incid.</span>
          <span class="badge na">ğŸš« No aplica</span>
        </div>

        <div class="divider"></div>

        <div id="monthlyAccordions" class="accordions"></div>
        <div id="monthlyEmpty" class="empty muted">AÃºn no hay puntos mensuales.</div>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â• GUÃA â•â•â•â•â•â•â•â•â•â•â• -->
    <section id="screenGuide" class="screen hidden">
      <div class="card glass">
        <div class="row space-between">
          <h2>GuÃ­a rÃ¡pida (audio)</h2>
          <button class="btn btn-icon" data-nav="home">â¬…</button>
        </div>
        <p class="muted">Pulsa "Reproducir" y el mÃ³vil te lo leerÃ¡ en voz alta (sin internet).</p>
        <div class="wavebox">
          <div class="wave"></div><div class="wave"></div><div class="wave"></div>
          <div class="wave"></div><div class="wave"></div>
        </div>
        <div class="row center">
          <button id="btnSpeak" class="btn btn-primary">â–¶ Reproducir</button>
          <button id="btnStopSpeak" class="btn btn-ghost">â¹ Parar</button>
        </div>
        <div class="divider"></div>
        <textarea id="guideText" class="input textarea" rows="10"></textarea>
      </div>
    </section>

    <!-- â•â•â•â•â•â•â•â•â•â•â• AJUSTES MODAL â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="modalSettings" class="modal hidden">
      <div class="modal-card glass">
        <div class="row space-between">
          <h2>Ajustes</h2>
          <button id="btnCloseSettings" class="btn btn-icon">âœ–</button>
        </div>
        <div class="grid2">
          <div class="panel glass-lite">
            <h3>LejÃ­a / dosis</h3>
            <label class="label">% lejÃ­a (cloro activo aprox.)</label>
            <input id="bleachPct" class="input" type="number" min="1" max="12" step="0.5" />
            <label class="label">Objetivo ppm (mg/L)</label>
            <input id="targetPpm" class="input" type="number" min="1" step="1" />
          </div>
          <div class="panel glass-lite">
            <h3>Tiempos</h3>
            <label class="label">Tiempo base (min)</label>
            <input id="baseMin" class="input" type="number" min="1" step="1" />
            <label class="label">Factor por litro (min/L)</label>
            <input id="factorPerL" class="input" type="number" min="0" step="0.01" />
            <div class="muted tiny">Auto = base + (L Ã— factor). Factor 0 = tiempo fijo.</div>
          </div>
        </div>
        <div class="divider"></div>
        <div class="row">
          <button id="btnSaveSettings" class="btn btn-primary" style="flex:1">Guardar</button>
          <button id="btnResetSettings" class="btn btn-danger">Restablecer</button>
        </div>
      </div>
    </div>

  </main>

  <!-- â•â•â•â•â•â•â•â•â•â•â• BARRA FLOTANTE DE CRONÃ“METROS â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="floatTimers" class="float-bar hidden"></div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• TOAST â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="uiToast" class="toast hidden"></div>

  <!-- â•â•â•â•â•â•â•â•â•â•â• MODAL PERSONALIZADO (reemplaza alert/confirm/prompt) â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="uiModal" class="modal hidden" style="z-index:50">
    <div class="modal-card glass" style="max-width:400px;width:92%">
      <div id="uiModalTitle" style="font-weight:800;font-size:17px;margin-bottom:8px"></div>
      <div id="uiModalBody" style="color:var(--muted);font-size:14px;line-height:1.5;margin-bottom:12px;white-space:pre-wrap"></div>
      <input id="uiModalInput" class="input hidden" style="margin-bottom:12px" />
      <div class="row" style="justify-content:flex-end;gap:8px">
        <button id="uiModalCancel" class="btn btn-ghost hidden">Cancelar</button>
        <button id="uiModalOk" class="btn btn-primary">Aceptar</button>
      </div>
    </div>
  </div>

  <script type="module" src="app.js"></script>
</body>
</html>
